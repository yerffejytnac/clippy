name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run build

      - name: Run unit tests
        run: bun test || echo "No tests configured yet"

      # ============================================================
      # E2E: Crawl a sample site
      # ============================================================
      - name: E2E - Crawl sample site
        run: |
          echo "=== Crawling docs.expo.dev ==="
          node dist/bin/clippy.js https://docs.expo.dev/versions/unversioned -o test-output --max-pages 5

          echo "=== Verify output directory created ==="
          ls -lh test-output/

          if [ ! -d "test-output" ]; then
            echo "::error::test-output directory was not created!"
            exit 1
          fi

          # Count markdown files
          MD_COUNT=$(find test-output -name "*.md" | wc -l)
          echo "Found $MD_COUNT markdown files"

          if [ "$MD_COUNT" -lt 1 ]; then
            echo "::error::No markdown files were created!"
            exit 1
          fi
          echo "✅ Crawl successful"

      - name: E2E - Verify markdown content
        run: |
          echo "=== Checking markdown files ==="

          # Show first file
          FIRST_FILE=$(find test-output -name "*.md" | head -1)
          echo "Sample file: $FIRST_FILE"
          head -20 "$FIRST_FILE"

          # Verify frontmatter exists
          if ! head -1 "$FIRST_FILE" | grep -q "^---"; then
            echo "::error::No frontmatter found in markdown files!"
            exit 1
          fi

          echo "✅ Markdown files valid"

      - name: E2E - Crawl docs site (larger test)
        run: |
          echo "=== Crawling httpbin.org ==="
          node dist/bin/clippy.js https://httpbin.org -o httpbin-output --max-pages 10 --depth 1

          ls -lh httpbin-output/
          MD_COUNT=$(find httpbin-output -name "*.md" | wc -l)
          echo "Created $MD_COUNT markdown files"
          echo "✅ Larger crawl successful"

      - name: Cleanup
        run: rm -rf test-output httpbin-output

  # ============================================================
  # Test on multiple Node versions
  # ============================================================
  test-node-versions:
    name: Node ${{ matrix.node }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ["20", "22"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup bun
        uses: oven-sh/setup-bun@v1

      - name: Install and build
        run: |
          bun install
          bun run build

      - name: Quick smoke test
        run: |
          node dist/bin/clippy.js --help
          node dist/bin/clippy.js https://docs.expo.dev/versions/unversioned -o smoke-output --max-pages 2
          ls -lh smoke-output/
          rm -rf smoke-output
          echo "✅ Node ${{ matrix.node }} works"

  # ============================================================
  # Summary
  # ============================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test, test-node-versions]
    if: success()

    steps:
      - name: Report success
        run: |
          echo "✅ All CI checks passed!"
          echo ""
          echo "- Build: ✓"
          echo "- E2E crawl: ✓"
          echo "- CLI commands: ✓"
          echo "- Node 20/22: ✓"
